<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ESP32 IoT</title>

  <!-- Th∆∞ vi·ªán -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      background: #eef9f8;
    }
    .header {
  background: #4eb9b7;
  color: #fff;
  padding: 1.0rem;
  font-size: 1.7rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  text-align: center;
}

/* N√∫t m≈©i t√™n n·ªïi b·∫≠t n·∫±m s√°t r√¨a tr√°i */
.back-btn {
  position: absolute;
  left: 20px;
  background: rgba(255, 255, 255, 0.15); /* n·ªÅn nh·∫°t n·ªïi b·∫≠t */
  border: none;
  color: #fff;
  font-size: 1.5rem;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  transition: background 0.3s ease;
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Ti√™u ƒë·ªÅ gi·ªØ cƒÉn gi·ªØa */
.title-text {
  flex: none;
  max-width: 80%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

  
    .threshold-box {
      background: #fff;
      border-radius: 10px;
      margin: 1.2rem auto;
      padding: 1rem 2rem;
      max-width: 800px;
      box-shadow: 0 6px 16px rgba(0,0,0,.1);
      text-align: center;
      font-weight: 700;
    }
    .threshold-box label {
      font-weight: bold;
      margin: 0 .5rem;
    }
    .threshold-box input {
      width: 70px;
      text-align: center;
      padding: .3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .threshold-box button {
      margin-left: .8rem;
      background: #4eb9b7;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: .5rem 1rem;
      font-weight: 700;
      cursor: pointer;
    }
  
    .status-message { margin-top: .6rem; font-weight: 700; }
    .normal { color: #2e7d32; }
    .warning { color: #c62828; }
  
    .dashboard {
      display: flex;
      flex-wrap: wrap;
      gap: 1.8rem;
      justify-content: center;
      padding: 1.5rem;
    }
  
    .chart-container {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 6px 16px rgba(0,0,0,.1);
      width: 650px;
      max-width: 95vw;
      position: relative;
      padding: 3.2rem 1rem 1rem;
    }
  
    .chart-box { height: 290px; margin-bottom: 1rem; }
  
    .sensor-card {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #fff;
      border-radius: 12px;
      padding: .6rem 1rem;
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
  
    /* LOOKUP: tra c·ª©u ng√†y gi·ªù */
    .lookup-grid {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      max-width: 600px;
      margin: 0 auto 1rem;
    }
  
    .lookup-grid input, .lookup-grid select {
      padding: .55rem;
      border: 1px solid #ccc;
      border-radius: 20px;
      text-align: center;
      font-size: 1rem;
      background: #fff;
    }
  
    .lookup-grid select {
      width: 150px;
    }
  
    .date-wrapper {
      position: relative;
    }
  
    .date-wrapper input {
      width: 180px;
      padding: .6rem 2.5rem .6rem .8rem;
      font-size: 1rem;
      border-radius: 20px;
    }
  
    .calendar-icon {
      position: absolute;
      right: 1.2rem;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      font-size: 1.2rem;
      pointer-events: none;
    }
  
    .lookup-btn {
      background: #4eb9b7;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: .6rem 1.6rem;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
  
    .lookup-btn:hover {
      background-color: #3baaa8;
    }
    .table-container {
  max-height: 260px;
  overflow-y: auto;
  overflow-x: auto;
  background: white;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 0.75rem;
  width: 100%;
}

/* ƒê·ªìng b·ªô k√≠ch th∆∞·ªõc b·∫£ng */
table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;
  min-width: 950px; /* ‚ö†Ô∏è ƒë·∫£m b·∫£o c·∫£ 2 b·∫£ng r·ªông nh∆∞ nhau */
}

/* √î b·∫£ng */
th, td {
  border: 1px solid #ccc;
  padding: .5rem .6rem;
  font-size: 0.9rem;
  text-align: center;
  background: #fff;
  word-break: break-word;
}

/* Ti√™u ƒë·ªÅ c·ªë ƒë·ªãnh */
thead th {
  position: sticky;
  top: 0;
  background: #b2dfdb;
  z-index: 10;
  font-weight: 700;
  box-shadow: 0 2px 2px rgba(0,0,0,0.03);
}

/* D√≤ng ch·∫µn ƒë·ªïi m√†u */
tbody tr:nth-child(even) {
  background: #f5f5f5;
}

/* bo g√≥c ƒë·∫πp */
thead th:first-child {
  border-top-left-radius: 8px;
}
thead th:last-child {
  border-top-right-radius: 8px;
}
  
 

    tbody tr:nth-child(even) {
      background: #f5f5f5;
    }
  
    .link {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .35rem;
      margin: 2rem auto 3rem;
    }
  
    .link a {
      background: #4eb9b7;
      color: #fff;
      padding: .5rem 1.2rem;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
    }
  
    .link small {
      color: #333;
      }

  
    /* ---------- MOBILE ‚â§ 768px ---------- */
   /* ---------- MOBILE ‚â§ 768px ---------- */
@media (max-width: 768px) {

  /* ===== HEADER ===== */
  .header {
    font-size: 1.25rem;
    padding: 1rem 1rem 1rem 3.2rem;
  }

  .title-text {
    font-size: 1rem;
    padding: 0 0.5rem;
    max-width: 100%;
    text-align: center;
  }

  .back-btn {
    width: 36px;
    height: 36px;
    font-size: 1.2rem;
    left: 8px;
  }


  /* ===== DASHBOARD ===== */
  .dashboard{
    flex-direction:column;
    align-items:center;
  }
  .chart-container{
    width:94%;
    padding:3.2rem 1rem 1rem;
    margin-bottom:1.5rem;
  }
  .chart-box{height:260px}
  .sensor-card{
    font-size:1.1rem;
    padding:.6rem 1rem;
    top:12px;left:12px;
  }

  /* ===== THRESHOLD (x·∫øp d·ªçc) ===== */
  .threshold-box{
    width:max-content;
    margin:1.2rem auto 0;
    padding:1rem 1.5rem;
    font-size:.95rem;
    display:grid;
    grid-template-columns:1fr;
    row-gap:.8rem;
    text-align:center;
  }
  .threshold-box label{font-weight:bold;justify-self:center}
  .threshold-box input{width:90px}
  .threshold-box button{
    grid-column:1/-1;
    justify-self:center;
    padding:.5rem 1rem;
    max-width:240px;
    margin-top:.2rem;
  }
  .threshold-box .status-message{
    grid-column:1/-1;
    margin-top:1rem;
    font-weight:bold;
  }

  /* ===== LOOKUP ===== */
  .lookup-grid{
    flex-direction:column;       /* x·∫øp d·ªçc to√†n b·ªô */
    gap:.85rem;
    align-items:stretch;
  }

  /* c·ª•m ng√†y + icon */
  .date-wrapper,
  #lookupTime{
    flex:1 1 100%;
  }
  .date-wrapper input,
  #lookupTime {
    width: 100%;
    border-radius: 20px;
    font-size: 1rem;
    padding: 0.6rem;
    border: 1px solid #ccc;
    /* G·ª† d√≤ng n√†y n·∫øu ·∫£nh h∆∞·ªüng ƒë·∫øn dropdown */
     text-align: left; 
    box-sizing: border-box;
  }


  /* ·∫©n ‚Äúorder‚Äù c≈©, chuy·ªÉn sang h√†ng m·ªõi */
  .lookup-btn{
    align-self:center;           /* cƒÉn gi·ªØa */
    order:3;                     /* lu√¥n ·ªü cu·ªëi */
    width:100%;                  /* full kh·ªëi ‚Äì gi·ªëng ·∫£nh */
    max-width:320px;
    padding:.7rem 1rem;
    font-size:1.05rem;
    background:#4eb9b7;
    color:#fff;
    border:none;
    border-radius:30px;
    font-weight:bold;
    cursor:pointer;
  }

  /* b·∫£ng k·∫øt qu·∫£ */
  .table-container{
    margin-top:.75rem;
    max-height:260px;
    overflow:auto;
  }
  input[type="time"]::-webkit-calendar-picker-indicator {
  display: none;
  -webkit-appearance: none;
 }
}
  </style>
  

</head>
<body>

  <div class="header">
    <span class="title-text">M√î H√åNH 1 H·ªÜ TH·ªêNG GI√ÅM S√ÅT XE T·∫¢I ƒê√îNG L·∫†NH <br>D√ôNG IoT ESP32</span>
  </div>  
  
  <div class="threshold-box">
    <div style="margin-bottom: 10px;">Ng∆∞·ª°ng c·∫£m bi·∫øn 1:</div>
    <label>Ng∆∞·ª°ng tr√™n:<input id="upperThreshold1" type="number">¬∞C</label>
    <label style="margin-left:.8rem;">Ng∆∞·ª°ng d∆∞·ªõi:<input id="lowerThreshold1" type="number">¬∞C</label>
    <button onclick="applyThreshold1()">√Åp d·ª•ng</button>
    <div id="tempStatus1" class="status-message">Tr·∫°ng th√°i nhi·ªát ƒë·ªô: --</div>
  </div>    
  
  <div class="threshold-box">
    <div style="margin-bottom: 10px;">Ng∆∞·ª°ng c·∫£m bi·∫øn 2:</div>
    <label>Ng∆∞·ª°ng tr√™n:<input id="upperThreshold2" type="number">¬∞C</label>
    <label style="margin-left:.8rem;">Ng∆∞·ª°ng d∆∞·ªõi:<input id="lowerThreshold2" type="number">¬∞C</label>
    <button onclick="applyThreshold2()">√Åp d·ª•ng</button>
    <div id="tempStatus" class="status-message">Tr·∫°ng th√°i nhi·ªát ƒë·ªô: --</div>
  </div>  


  <div class="dashboard">
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-thermometer-half" style="color:#07d3f2;margin-right:8px"></i>Nhi·ªát ƒë·ªô 1: <span id="temp">--</span>¬∞C</div><div id="tempChart" class="chart-box"></div></div>
    <div class="chart-container">
      <div class="sensor-card">
        <i class="fas fa-thermometer-half" style="color:#2b09a7;margin-right:8px"></i>
        Nhi·ªát ƒë·ªô 2: <span id="temp2">--</span>¬∞C
      </div>
      <div id="temp2Chart" class="chart-box"></div>
    </div>
    
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-charging-station" style="color:#41f947;margin-right:8px"></i>ƒêi·ªán √°p: <span id="voltage">--</span>V</div><div id="voltageChart" class="chart-box"></div></div>
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-bolt" style="color:#f3722c;margin-right:8px"></i>D√≤ng ƒëi·ªán: <span id="current">--</span>A</div><div id="currentChart" class="chart-box"></div></div>
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-lightbulb" style="color:#f9c74f;margin-right:8px"></i>C√¥ng su·∫•t: <span id="power">--</span>W</div><div id="powerChart" class="chart-box"></div></div>
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-battery-full" style="color:#9b51e0;margin-right:8px"></i>NƒÉng l∆∞·ª£ng: <span id="energy">--</span>kWh</div><div id="energyChart" class="chart-box"></div></div>
    <div class="chart-container"><div class="sensor-card"><i class="fas fa-broadcast-tower" style="color:#00bcd4;margin-right:8px"></i>T·∫ßn s·ªë: <span id="frequency">--</span>Hz</div><div id="frequencyChart" class="chart-box"></div></div>

    <div class="chart-container">
      <div class="sensor-card"><i class="fas fa-table" style="color:#4eb9b7;margin-right:8px"></i>Tra c·ª©u d·ªØ li·ªáu</div>
      <div style="padding-top:20px">
        <div class="lookup-grid">
          <div class="date-wrapper">
            <input id="lookupDate" placeholder="yyyy/MM/dd">
            <i class="fas fa-calendar-alt calendar-icon"></i>
          </div>
          <select id="lookupHour">
            <option value="">-- Ch·ªçn gi·ªù --</option>
            <script>
              for(let h=0; h<24; h++){
                const start = h.toString().padStart(2, '0');
                const end = ((h + 1) % 24).toString().padStart(2, '0');
                document.write(`<option value="${start}">${start}:00 - ${end}:00</option>`);
              }
            </script>
          </select>
          <button id="lookup" class="lookup-btn">Tra c·ª©u</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Ng√†y</th><th>Gi·ªù</th><th>ƒêi·ªán √°p(V)</th><th>D√≤ng(A)</th>
                <th>C√¥ng su·∫•t<br>(kW)</th><th>NƒÉng l∆∞·ª£ng(kWh)</th><th>T·∫ßn s·ªë(Hz)</th>
                <th>Nhi·ªát ƒë·ªô 1(¬∞C)</th><th>Nhi·ªát ƒë·ªô 2(¬∞C)</th> <!-- th√™m d√≤ng n√†y -->
              </tr>
            </thead>            
            <tbody id="resultTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  
  <div class="chart-container" style="margin: 0 auto;">
    <div class="sensor-card">
      <i class="fas fa-temperature-high" style="color:#ff5722;margin-right:8px"></i>
      Tra c·ª©u theo nhi·ªát ƒë·ªô
    </div>
    <div style="padding-top:20px">
      <div class="lookup-grid">
        <div class="date-wrapper">
          <input id="tempLookupDate" placeholder="yyyy/MM/dd">
          <i class="fas fa-calendar-alt calendar-icon"></i>
        </div>
        <input type="number" id="tempMin" placeholder="T·ª´ (¬∞C)" style="min-width:120px;">
        <input type="number" id="tempMax" placeholder="ƒê·∫øn (¬∞C)" style="min-width:120px;">
        <button onclick="filterByTemperature()" class="lookup-btn">L·ªçc</button>
      </div>    
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Ng√†y</th><th>Gi·ªù</th><th>ƒêi·ªán √°p(V)</th><th>D√≤ng(A)</th>
              <th>C√¥ng su·∫•t(kW)</th><th>NƒÉng l∆∞·ª£ng(kWh)</th><th>T·∫ßn s·ªë(Hz)</th>
              <th>Nhi·ªát ƒë·ªô 1(¬∞C)</th><th>Nhi·ªát ƒë·ªô 2(¬∞C)</th>
            </tr>
          </thead>
          <tbody id="tempFilterTable"></tbody>
        </table>
      </div>
    </div>
  </div>

<div class="link">
    <a href="https://docs.google.com/spreadsheets/d/1Ykm-1BM1CLbGPo0fSaqCAMS0vFZ6tS3gDCXYmSM1pzI/edit?gid=0#gid=0" target="_blank">
      XEM D·ªÆ LI·ªÜU TR√äN GOOGLE SHEET
    </a>
    <small>(Click ƒë·ªÉ xem l·∫°i c√°c gi√° tr·ªã ƒë√£ l∆∞u)</small>
  </div>

  <script>
    flatpickr('#lookupDate', { dateFormat: 'Y/m/d', altInput: true, altFormat: 'Y/m/d' });
    flatpickr('#tempLookupDate', { dateFormat: 'Y/m/d', altInput: true, altFormat: 'Y/m/d' });
    Highcharts.setOptions({ time: { useUTC: false } });
    
    const COLORS = {
      Temperature1: '#07d3f2',
      Temperature2: '#2b09a7',
      Voltage: '#41f947',
      Current: '#f3722c',
      Power: '#f9c74f',
      Energy: '#9b51e0',
      Frequency: '#00bcd4'
    };
    
    const charts = {}, MAX_POINTS = 50;
    
    const metrics = [
      ['Temperature1', '¬∞C', 'tempChart'],
      ['Temperature2', '¬∞C', 'temp2Chart'],
      ['Voltage', 'V', 'voltageChart'],
      ['Current', 'A', 'currentChart'],
      ['Power', 'W', 'powerChart'],
      ['Energy', 'kWh', 'energyChart'],
      ['Frequency', 'Hz', 'frequencyChart']
    ];
    
    metrics.forEach(([title, u, div]) => {
      charts[title] = Highcharts.chart(div, {
        chart: { type: 'line', marginRight: 10 },
        title: { text: title },
        xAxis: {
          type: 'datetime',
          tickInterval: 30000,
          labels: { format: '{value:%H:%M:%S}' }
        },
        yAxis: { title: { text: null } },
        legend: { enabled: false },
        credits: { enabled: false },
        tooltip: {
          formatter() {
            return `<b>${this.series.name}</b><br/>${Highcharts.dateFormat('%H:%M:%S', this.x)}<br/>${Highcharts.numberFormat(this.y, 2)} ${u}`;
          }
        },
        series: [{ name: title, data: [], color: COLORS[title] }]
      });
    });
    
    let lastTs = 0;
    function updateCharts(p) {
      const { timestamp: ts, voltage, current, power, energy, temp1, temp2, frequency } = p;
      if (!ts || ts <= lastTs) return;
      lastTs = ts;
    
      const map = [
        ['Temperature1', temp1, 'temp'],
        ['Temperature2', temp2, 'temp2'],
        ['Voltage', voltage, 'voltage'],
        ['Current', current, 'current'],
        ['Power', power, 'power'],
        ['Energy', energy, 'energy'],
        ['Frequency', frequency, 'frequency']
      ];
    
      map.forEach(([title, val, spanId]) => {
        if (isNaN(val)) return;
        const s = charts[title].series[0];
        s.addPoint([ts, val], true, s.data.length >= MAX_POINTS);
        const el = document.getElementById(spanId);
        if (el) el.textContent = val.toFixed(2);
      });
    
      checkTempStatus();
    }
    
    async function fetchSensorData() {
  try {
    const r = await fetch('/api/sensor', { cache: 'no-store' });
    const { history, thresholds } = await r.json();

    // üîß G√°n l·∫°i ng∆∞·ª°ng c√†i ƒë·∫∑t n·∫øu c√≥
    if (thresholds) {
      const upperThreshold1 = document.getElementById('upperThreshold1');
      const lowerThreshold1 = document.getElementById('lowerThreshold1');
      const upperThreshold2 = document.getElementById('upperThreshold2');
      const lowerThreshold2 = document.getElementById('lowerThreshold2');

      if (upperThreshold1 && !upperThreshold1.value && thresholds.tempHigh1 !== undefined)
        upperThreshold1.value = thresholds.tempHigh1;
      if (lowerThreshold1 && !lowerThreshold1.value && thresholds.tempLow1 !== undefined)
        lowerThreshold1.value = thresholds.tempLow1;

      if (upperThreshold2 && !upperThreshold2.value && thresholds.tempHigh2 !== undefined)
        upperThreshold2.value = thresholds.tempHigh2;
      if (lowerThreshold2 && !lowerThreshold2.value && thresholds.tempLow2 !== undefined)
        lowerThreshold2.value = thresholds.tempLow2;
    }

    if (Array.isArray(history) && history.length > 0) {
      history.forEach(updateCharts);
      const latest = history[history.length - 1];
      if (latest) {
        document.getElementById('temp').textContent      = !isNaN(latest.temp1) ? latest.temp1.toFixed(2) : '--';
        document.getElementById('temp2').textContent     = !isNaN(latest.temp2) ? latest.temp2.toFixed(2) : '--';
        document.getElementById('voltage').textContent   = !isNaN(latest.voltage) ? latest.voltage.toFixed(2) : '--';
        document.getElementById('current').textContent   = !isNaN(latest.current) ? latest.current.toFixed(2) : '--';
        document.getElementById('power').textContent     = !isNaN(latest.power) ? latest.power.toFixed(2) : '--';
        document.getElementById('energy').textContent    = !isNaN(latest.energy) ? latest.energy.toFixed(3) : '--';
        document.getElementById('frequency').textContent = !isNaN(latest.frequency) ? latest.frequency.toFixed(2) : '--';
      }
      checkTempStatus();
    }
  } catch (e) {
    console.warn('Fetch error', e);
  }
}

    async function updateThresholds() {
      const low = parseFloat(lowerThreshold.value), high = parseFloat(upperThreshold.value);
      if (isNaN(low) || isNaN(high)) {
        alert('Nh·∫≠p ƒë·ªß hai ng∆∞·ª°ng!');
        return;
      }
      if (low > high) {
        alert('Ng∆∞·ª°ng th·∫•p ph·∫£i ‚â§ ng∆∞·ª°ng cao!');
        return;
      }
      try {
        const r = await fetch('/api/sensor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tempLow: low, tempHigh: high })
        });
        if (!r.ok) throw new Error(await r.text());
        alert('ƒê√£ l∆∞u ng∆∞·ª°ng th√†nh c√¥ng!');
        checkTempStatus();
      } catch (e) {
        alert('L·ªói: ' + e.message);
      }
    }
    
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShIPqq_63GhPwJPFtUPOzkj5QkI_Q1Xt4Eusy_W4yFIHbNBbXXAKmiX4zV6lirsyJiRUJ76KUT4pMk/pub?gid=0&single=true&output=csv';
    let cacheRows = null;
    
    async function loadData() {
      if (cacheRows) return cacheRows;
      const t = await (await fetch(CSV_URL)).text();
      cacheRows = Papa.parse(t.trim(), { dynamicTyping: false }).data;
      return cacheRows;
    }
    
    function appendRow(r) {
      const tr = document.createElement('tr');
      r.forEach(c => {
        const td = document.createElement('td');
        td.textContent = c || '';
        tr.appendChild(td);
      });
      resultTable.appendChild(tr);
    }
    
    function clearTable(msg) {
      resultTable.innerHTML = '';
      if (msg) {
        const tr = document.createElement('tr'),
              td = document.createElement('td');
        td.colSpan = 9;
        td.textContent = msg;
        tr.appendChild(td);
        resultTable.appendChild(tr);
      }
    }
    
    document.getElementById('lookup').addEventListener('click', async () => {
      const d = document.getElementById('lookupDate').value;
      const h = document.getElementById('lookupHour').value;
      if (!d || !h) {
        alert('Ch·ªçn ng√†y & gi·ªù!');
        return;
      }
    
      const [y, m, dd] = d.split('/');
      const targetDate = `${y}-${m}-${dd}`;
      const targetTime = h + ':';
    
      try {
        const rows = await loadData();
        const match = rows.slice(1).filter(r => r[0] === targetDate && String(r[1]).startsWith(targetTime));
        clearTable();
        if (!match.length) {
          clearTable('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.');
          return;
        }
        match.forEach(appendRow);
      } catch (e) {
        console.error(e);
        clearTable('L·ªói t·∫£i d·ªØ li·ªáu');
      }
    });
    
    function filterByTemperature() {
      const min = parseFloat(document.getElementById('tempMin').value);
      const max = parseFloat(document.getElementById('tempMax').value);
      const dateInput = document.getElementById('tempLookupDate').value;
      const tbody = document.getElementById('tempFilterTable');
      tbody.innerHTML = '';
    
      if (isNaN(min) || isNaN(max)) {
        tbody.innerHTML = `<tr><td colspan="9">Vui l√≤ng nh·∫≠p kho·∫£ng nhi·ªát ƒë·ªô h·ª£p l·ªá.</td></tr>`;
        return;
      }
    
      if (min > max) {
        tbody.innerHTML = `<tr><td colspan="9">Gi√° tr·ªã "T·ª´" ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng "ƒê·∫øn".</td></tr>`;
        return;
      }
    
      loadData().then(rows => {
        const matches = rows.slice(1).filter(r => {
          const t1 = parseFloat(r[7]);
          const t2 = parseFloat(r[8]);
          return (!isNaN(t1) && t1 >= min && t1 <= max) || (!isNaN(t2) && t2 >= min && t2 <= max);
        });
    
        if (!matches.length) {
          tbody.innerHTML = `<tr><td colspan="9">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>`;
          return;
        }
    
        matches.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(c => {
            const td = document.createElement('td');
            td.textContent = c || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }).catch(err => {
        tbody.innerHTML = `<tr><td colspan="9">L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
      });
    }
    
    // üü© B·ªî SUNG: Ki·ªÉm tra v√† √°p d·ª•ng ng∆∞·ª°ng cho c·∫£m bi·∫øn 1 & 2
    function applyThreshold1() {
      checkTempStatus1();
    }
    
    function applyThreshold2() {
      checkTempStatus2();
    }
    
    function checkTempStatus1() {
      const low = parseFloat(document.getElementById('lowerThreshold1').value),
            high = parseFloat(document.getElementById('upperThreshold1').value),
            t = parseFloat(document.getElementById('temp').textContent) || NaN;
    
      const status = document.getElementById('tempStatus1');
    
      if (isNaN(t)) {
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: --';
        status.className = 'status-message';
        return;
      }
    
      if ((!isNaN(low) && t < low) || (!isNaN(high) && t > high)) {
        let diff = '';
        if (!isNaN(high) && t > high) diff = ` (v∆∞·ª£t ${(t - high).toFixed(2)}¬∞C)`;
        else if (!isNaN(low) && t < low) diff = ` (th·∫•p h∆°n ${(low - t).toFixed(2)}¬∞C)`;
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: C·∫¢NH B√ÅO' + diff;
        status.className = 'status-message warning';
      } else {
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: B√åNH TH∆Ø·ªúNG';
        status.className = 'status-message normal';
      }
    }
    
    function checkTempStatus2() {
      const low = parseFloat(document.getElementById('lowerThreshold2').value),
            high = parseFloat(document.getElementById('upperThreshold2').value),
            t = parseFloat(document.getElementById('temp2').textContent) || NaN;
    
      const status = document.getElementById('tempStatus');
    
      if (isNaN(t)) {
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: --';
        status.className = 'status-message';
        return;
      }
    
      if ((!isNaN(low) && t < low) || (!isNaN(high) && t > high)) {
        let diff = '';
        if (!isNaN(high) && t > high) diff = ` (v∆∞·ª£t ${(t - high).toFixed(2)}¬∞C)`;
        else if (!isNaN(low) && t < low) diff = ` (th·∫•p h∆°n ${(low - t).toFixed(2)}¬∞C)`;
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: C·∫¢NH B√ÅO' + diff;
        status.className = 'status-message warning';
      } else {
        status.textContent = 'Tr·∫°ng th√°i nhi·ªát ƒë·ªô: B√åNH TH∆Ø·ªúNG';
        status.className = 'status-message normal';
      }
    }
    
    function checkTempStatus() {
      checkTempStatus1();
      checkTempStatus2();
    }
    
    fetchSensorData();
    setInterval(fetchSensorData, 30000);
    </script>
    
</body>
</html>
